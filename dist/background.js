(()=>{class a{constructor(){this.hibernationTimer=null,this.tabDataCache={},this.lastActivityCheck=Date.now(),this.initialize()}async initialize(){try{if(console.log("Tab Weaver Background Service Worker initializing..."),!chrome||!chrome.runtime)throw new Error("Chrome runtime APIs not available");try{const a=await chrome.storage.local.get("tabData");this.tabDataCache=a.tabData||{}}catch(a){console.error("Error loading tab data:",a),this.tabDataCache={}}this.setupEventListeners(),this.startHibernationMonitoring(),await this.initializePerformanceTracking(),console.log("Tab Weaver Background Service Worker initialized successfully")}catch(a){console.error("Failed to initialize Tab Weaver:",a),setTimeout(()=>{this.initialize().catch(a=>{console.error("Retry initialization failed:",a)})},2e3)}}setupEventListeners(){try{chrome.tabs&&(chrome.tabs.onCreated.addListener(a=>this.handleTabCreated(a)),chrome.tabs.onUpdated.addListener((a,e,t)=>this.handleTabUpdated(a,e,t)),chrome.tabs.onRemoved.addListener(a=>this.handleTabRemoved(a)),chrome.tabs.onActivated.addListener(a=>this.handleTabActivated(a))),chrome.runtime&&chrome.runtime.onMessage&&chrome.runtime.onMessage.addListener((a,e,t)=>(this.handleMessage(a,e,t),!0)),chrome.commands&&chrome.commands.onCommand.addListener(a=>this.handleCommand(a)),chrome.alarms&&chrome.alarms.onAlarm.addListener(a=>this.handleAlarm(a)),this.setupContextMenu(),chrome.runtime&&(chrome.runtime.onStartup.addListener(()=>this.handleStartup()),chrome.runtime.onInstalled.addListener(a=>this.handleInstall(a)))}catch(a){console.error("Error setting up event listeners:",a)}}async handleTabCreated(a){if(!a.id)return;const e={id:a.id,url:a.url||"",title:a.title||"",favIconUrl:a.favIconUrl,windowId:a.windowId,index:a.index,active:a.active,pinned:a.pinned,audible:a.audible||!1,mutedInfo:a.mutedInfo,timeOpened:Date.now(),timeLastActive:a.active?Date.now():0,totalActiveDuration:0,hibernated:!1,hibernationCount:0,hasUnsavedData:!1};this.tabDataCache[a.id]=e,await this.saveTabData(),await this.updatePerformanceMetrics()}async handleTabUpdated(a,e,t){if(!this.tabDataCache[a])return void await this.handleTabCreated(t);const i={};if(e.url&&(i.url=e.url),e.title&&(i.title=e.title),e.favIconUrl&&(i.favIconUrl=e.favIconUrl),void 0!==e.pinned&&(i.pinned=e.pinned),void 0!==e.audible&&(i.audible=e.audible),e.mutedInfo&&(i.mutedInfo=e.mutedInfo),"complete"===e.status)try{chrome.tabs.sendMessage(a,{type:"CHECK_FORM_DATA"})}catch(a){}Object.keys(i).length>0&&(Object.assign(this.tabDataCache[a],i),await this.saveTabData())}async handleTabRemoved(a){delete this.tabDataCache[a],await this.saveTabData(),await this.updatePerformanceMetrics()}async handleTabActivated(a){const{tabId:e,windowId:t}=a;if(this.tabDataCache[e]){const a=Date.now(),i=this.tabDataCache[e];i.timeLastActive>0&&(i.totalActiveDuration+=a-i.timeLastActive),i.timeLastActive=a,i.active=!0,i.hibernated&&await this.restoreTab(e),Object.values(this.tabDataCache).forEach(a=>{a.windowId===t&&a.id!==e&&(a.active=!1)}),await this.saveTabData()}}async handleMessage(a,e,t){try{switch(a.type){case"HIBERNATE_TAB":await this.hibernateTab(a.tabId),t({success:!0});break;case"RESTORE_TAB":await this.restoreTab(a.tabId),t({success:!0});break;case"GET_TAB_DATA":a.tabId?t(this.tabDataCache[a.tabId]):t(this.tabDataCache);break;case"UPDATE_TAB_ACTIVITY":this.tabDataCache[a.tabId]&&(this.tabDataCache[a.tabId].timeLastActive=a.timestamp,await this.saveTabData()),t({success:!0});break;case"GET_PERFORMANCE_METRICS":t(await this.getPerformanceMetrics());break;case"FORM_DATA_DETECTED":e.tab&&this.tabDataCache[e.tab.id]&&(this.tabDataCache[e.tab.id].hasUnsavedData=a.hasUnsavedData,await this.saveTabData()),t({success:!0});break;case"PAGE_ACTIVITY":e.tab&&this.tabDataCache[e.tab.id]&&(this.tabDataCache[e.tab.id].timeLastActive=a.timestamp,await this.saveTabData()),t({success:!0});break;default:t({error:"Unknown message type"})}}catch(a){console.error("Error handling message:",a),t({error:a.message})}}async handleCommand(a){switch(a){case"open-command-palette":await this.openCommandPalette();break;case"hibernate-current-tab":const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});a.id&&await this.hibernateTab(a.id)}}async handleAlarm(a){switch(a.name){case"hibernation-check":await this.checkForHibernation();break;case"performance-update":await this.updatePerformanceMetrics()}}setupContextMenu(){chrome.contextMenus.create({id:"hibernate-tab",title:"Hibernate Tab",contexts:["page"]}),chrome.contextMenus.onClicked.addListener(async(a,e)=>{"hibernate-tab"===a.menuItemId&&e?.id&&await this.hibernateTab(e.id)})}async handleStartup(){console.log("Tab Weaver startup"),await this.syncExistingTabs()}async handleInstall(a){"install"===a.reason&&(console.log("Tab Weaver installed"),chrome.tabs.create({url:chrome.runtime.getURL("dist/options.html")})),await this.syncExistingTabs()}async syncExistingTabs(){const a=await chrome.tabs.query({});for(const e of a)e.id&&!this.tabDataCache[e.id]&&await this.handleTabCreated(e)}startHibernationMonitoring(){chrome.alarms.create("hibernation-check",{periodInMinutes:1}),chrome.alarms.create("performance-update",{periodInMinutes:5})}async checkForHibernation(){const a=await this.getSettings();if(!a.hibernation.enabled)return;const e=Date.now(),t=60*a.hibernation.timeThreshold*1e3;for(const[i,r]of Object.entries(this.tabDataCache)){const n=parseInt(i);await this.shouldHibernateTab(n,r,a.hibernation,e,t)&&await this.hibernateTab(n)}}async shouldHibernateTab(a,e,t,i,r){return!e.hibernated&&(!e.active&&((!t.excludePinned||!e.pinned)&&((!t.excludeAudible||!e.audible)&&((!t.excludeWithForms||!e.hasUnsavedData)&&i-e.timeLastActive>r))))}async hibernateTab(a){try{await chrome.tabs.discard(a),this.tabDataCache[a]&&(this.tabDataCache[a].hibernated=!0,this.tabDataCache[a].hibernationCount++,await this.saveTabData()),console.log(`Tab ${a} hibernated`),await this.updatePerformanceMetrics()}catch(e){console.error(`Failed to hibernate tab ${a}:`,e)}}async restoreTab(a){try{this.tabDataCache[a]&&(this.tabDataCache[a].hibernated=!1,await this.saveTabData()),console.log(`Tab ${a} restored`),await this.updatePerformanceMetrics()}catch(e){console.error(`Failed to restore tab ${a}:`,e)}}async openCommandPalette(){chrome.action.openPopup()}async updatePerformanceMetrics(){const a=Object.keys(this.tabDataCache).length,e=Object.values(this.tabDataCache).filter(a=>a.hibernated).length,t={totalTabsManaged:a,hibernatedTabs:e,memorySavedMB:50*e,cpuSavedPercent:e/Math.max(a,1)*20,lastCalculated:Date.now()};await chrome.storage.local.set({performanceMetrics:t})}async initializePerformanceTracking(){await this.updatePerformanceMetrics()}async saveTabData(){try{await chrome.storage.local.set({tabData:this.tabDataCache})}catch(a){console.error("Error saving tab data:",a)}}async getSettings(){try{return(await chrome.storage.local.get("settings")).settings||{hibernation:{enabled:!0,timeThreshold:15,excludePinned:!0,excludeAudible:!0,excludeWithForms:!0}}}catch(a){return console.error("Error getting settings:",a),{hibernation:{enabled:!0,timeThreshold:15,excludePinned:!0,excludeAudible:!0,excludeWithForms:!0}}}}async getPerformanceMetrics(){try{return(await chrome.storage.local.get("performanceMetrics")).performanceMetrics||{totalTabsManaged:0,hibernatedTabs:0,memorySavedMB:0,cpuSavedPercent:0,lastCalculated:Date.now()}}catch(a){return console.error("Error getting performance metrics:",a),{totalTabsManaged:0,hibernatedTabs:0,memorySavedMB:0,cpuSavedPercent:0,lastCalculated:Date.now()}}}}let e=null;if("undefined"!=typeof chrome&&chrome.runtime)try{e=new a}catch(t){console.error("Error initializing TabWeaver:",t),setTimeout(()=>{try{e=new a}catch(a){console.error("Retry failed:",a)}},1e3)}else setTimeout(()=>{"undefined"!=typeof chrome&&chrome.runtime&&(e=new a)},500)})();